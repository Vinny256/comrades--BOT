<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMRADES-MD | Silent Terminal</title>
    
    <link rel="icon" type="image/png" href="https://img.icons8.com/matrix/50/00ff41/matrix-desktop.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <style>
        :root { --matrix: #00ff41; --bg: #000; }
        * { box-sizing: border-box; }
        body { 
            margin: 0; background: var(--bg); color: #fff; 
            font-family: 'Share Tech Mono', monospace; overflow: hidden; 
        }
        
        /* CRT Effect */
        body::after {
            content: " "; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            z-index: 100; pointer-events: none; background-size: 100% 2px, 3px 100%;
        }

        #canvas { position: fixed; top:0; left:0; opacity: 0.15; z-index: 1; }
        .ui { position: relative; z-index: 10; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        .terminal {
            width: 90%; max-width: 550px; border: 1px solid var(--matrix);
            background: rgba(0,0,0,0.9); padding: 30px; box-shadow: 0 0 20px rgba(0,255,65,0.2);
        }

        .path { color: #555; font-size: 0.7rem; margin-bottom: 20px; text-transform: uppercase; }
        
        /* Input Styling */
        .iti { width: 100%; margin-bottom: 20px; }
        input[type="tel"] {
            width: 100% !important; background: transparent !important; border: 1px solid var(--matrix) !important;
            color: var(--matrix) !important; padding: 15px 15px 15px 85px !important; font-family: 'Share Tech Mono';
        }

        .btn-group { display: flex; gap: 10px; margin-bottom: 25px; }
        .btn { 
            flex: 1; padding: 15px; border: 1px solid var(--matrix); background: transparent; 
            color: var(--matrix); cursor: pointer; font-family: 'Share Tech Mono'; font-weight: bold;
            transition: 0.2s;
        }
        .btn:hover { background: var(--matrix); color: #000; }

        /* Stagnant Result Display */
        #display-master { 
            min-height: 100px; border-top: 1px solid #222; margin-top: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* Specific containers that only show on success */
        .result-box { display: none; width: 100%; padding: 20px; text-align: center; }
        .code-text { font-size: 2.8rem; color: var(--matrix); letter-spacing: 10px; font-weight: bold; margin: 15px 0; text-shadow: 0 0 10px var(--matrix); }
        
        .session-box { 
            display: none; border: 2px solid var(--matrix); padding: 20px; background: #001a00;
            width: 100%; margin-top: 20px; text-align: left;
        }
        
        .copy-btn { width: 100%; background: var(--matrix); color: #000; border: none; padding: 10px; font-weight: bold; cursor: pointer; }

        #loader { display: none; width: 100%; height: 2px; background: #111; position: relative; overflow: hidden; margin-bottom: 15px; }
        #loader::after { content: ""; position: absolute; left: -50%; width: 40%; height: 100%; background: var(--matrix); animation: scan 1s infinite; }
        @keyframes scan { from { left: -50%; } to { left: 100%; } }
    </style>
</head>
<body>

    <canvas id="canvas"></canvas>

    <div class="ui">
        <div class="terminal">
            <div style="display: flex; justify-content: space-between;">
                <div class="path">root@comrades-md:~/authentication</div>
                <div id="status" style="color: #444; font-size: 0.6rem;">IDLE</div>
            </div>

            <input type="tel" id="phone">

            <div class="btn-group">
                <button class="btn" onclick="triggerQR()">GET_QR_CODE</button>
                <button class="btn" onclick="triggerPairing()">GET_PAIRING_CODE</button>
            </div>

            <div id="loader"></div>

            <div id="display-master">
                <div id="pairing-area" class="result-box">
                    <div style="font-size: 0.6rem; color: #888;">WHATSAPP_PAIR_CODE</div>
                    <div id="pairing-code" class="code-text"></div>
                    <button class="copy-btn" onclick="copyText('pairing-code')">COPY_CODE</button>
                </div>

                <div id="qr-area" class="result-box">
                    <div id="qr-image-container"></div>
                </div>

                <div id="session-area" class="session-box">
                    <div style="color: var(--matrix); font-size: 0.6rem; margin-bottom: 10px;">> DECRYPTION_COMPLETE: SESSION_ID_FOUND</div>
                    <div id="session-id" style="word-break: break-all; color: #fff; margin-bottom: 15px; font-size: 0.8rem; border-left: 2px solid var(--matrix); padding-left: 10px;"></div>
                    <button class="copy-btn" onclick="copyText('session-id')">COPY_SESSION_ID</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        // Matrix Background
        const c = document.getElementById("canvas");
        const ctx = c.getContext("2d");
        c.width = window.innerWidth; c.height = window.innerHeight;
        const chars = "01";
        const fontSize = 16; const cols = c.width/fontSize; const drops = Array(Math.floor(cols)).fill(1);
        function draw() { ctx.fillStyle="rgba(0,0,0,0.05)"; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle="#0f0"; ctx.font=fontSize+"px monospace"; for(let i=0;i<drops.length;i++){ ctx.fillText(chars[Math.floor(Math.random()*chars.length)], i*fontSize, drops[i]*fontSize); if(drops[i]*fontSize > c.height && Math.random() > 0.975) drops[i]=0; drops[i]++; } }
        setInterval(draw, 50);

        function notify(msg, isErr = false) { Toastify({ text: msg, duration: 3000, style: { background: "#000", color: isErr ? "#f00" : "#0f0", border: `1px solid ${isErr ? '#f00' : '#0f0'}`, fontFamily: 'Share Tech Mono' } }).showToast(); }

        const socket = io("https://comrades-session-65daf07fdaad.herokuapp.com");
        const phoneInput = document.querySelector("#phone");
        const iti = window.intlTelInput(phoneInput, { separateDialCode: true, initialCountry: "ke", utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js" });

        let activeRequest = null; // "QR" or "PAIR"

        // Wipes display and stops background noise
        function resetDisplay() {
            document.getElementById('pairing-area').style.display = 'none';
            document.getElementById('qr-area').style.display = 'none';
            document.getElementById('session-area').style.display = 'none';
            document.getElementById('qr-image-container').innerHTML = '';
            document.getElementById('loader').style.display = 'block';
            document.getElementById('status').innerText = "WAITING...";
        }

        // --- MANUAL TRIGGER: QR ---
        function triggerQR() {
            activeRequest = "QR";
            resetDisplay();
            notify("POSTING_QR_REQUEST...");
            fetch(`${socket.io.uri}/start-qr`, { method: 'POST' });
        }

        // --- MANUAL TRIGGER: PAIRING ---
        function triggerPairing() {
            const num = iti.getNumber().replace(/\D/g, '');
            if(num.length < 10) return notify("ERR: INVALID_NUMBER", true);
            
            activeRequest = "PAIR";
            resetDisplay();
            notify(`POSTING_PAIR_REQUEST for +${num}...`);
            fetch(`${socket.io.uri}/start-pairing`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phoneNumber: num })
            });
        }

        // --- SOCKETS: ONLY REACT TO MANUAL TRIGGERS ---
        socket.on('qr', url => {
            if(activeRequest !== "QR") return; // Ignore if user didn't ask for QR
            document.getElementById('loader').style.display = 'none';
            document.getElementById('status').innerText = "QR_READY";
            document.getElementById('qr-area').style.display = 'block';
            document.getElementById('qr-image-container').innerHTML = `<img src="${url}" style="width:200px; border:4px solid #fff; padding:5px; background:#fff;">`;
            notify("QR_CODE_LOADED");
        });

        socket.on('pairing-code', code => {
            if(activeRequest !== "PAIR") return; // Ignore if user didn't ask for Pair
            document.getElementById('loader').style.display = 'none';
            document.getElementById('status').innerText = "PAIR_READY";
            document.getElementById('pairing-area').style.display = 'block';
            document.getElementById('pairing-code').innerText = code;
            notify("PAIRING_CODE_LOADED");
        });

        // --- FINAL SUCCESS: SESSION ID ---
        socket.on('session', id => {
            // Success event from backend! 
            // Wipe everything (QR or Pairing) and show the ID
            document.getElementById('loader').style.display = 'none';
            document.getElementById('qr-area').style.display = 'none';
            document.getElementById('pairing-area').style.display = 'none';
            
            document.getElementById('status').innerText = "CONNECTED";
            document.getElementById('session-area').style.display = 'block';
            document.getElementById('session-id').innerText = id;
            notify("SESSION_LINKED_SUCCESSFULLY!");
        });

        function copyText(id) {
            const text = document.getElementById(id).innerText;
            navigator.clipboard.writeText(text);
            notify("DATA_COPIED");
        }
    </script>
</body>
</html>
